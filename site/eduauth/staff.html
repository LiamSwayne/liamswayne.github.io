<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard</title>
    <script src="./show_alert.js"></script>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <style>
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('./Inter.woff2') format('woff2');
        }
        
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('./Inter.woff2') format('woff2');
        }

        :root {
            --accent-color: #0062ff;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        .container {
            background-color: white;
            border-radius: 20px;
            padding: 30px 40px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .title {
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 30px;
            font-weight: 700;
        }

        .request-list {
            margin-top: 20px;
        }

        .request-item {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .request-actions {
            margin-top: 10px;
        }

        .approve-button, .deny-button {
            padding: 5px 10px;
            margin-right: 10px;
            cursor: pointer;
        }

        .reload-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .reload-button:hover {
            background-color: #0056e0;
        }

        .no-requests {
            text-align: center;
            color: #666;
            margin-top: 20px;
        }

        .input-section {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .input-section input {
            padding: 10px;
            width: 80%;
            max-width: 300px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .input-section button {
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">Staff Dashboard</div>
        
        <div class="input-section">
            <input type="text" id="universityInput" placeholder="Enter University Name">
            <input type="text" id="staffIdInput" placeholder="Enter Staff ID">
            <button onclick="setCredentials()">Set Credentials</button>
        </div>

        <button id="reloadButton" class="reload-button">Reload Requests</button>

        <div class="request-list" id="requestList">
            <!-- Requests will be populated here -->
        </div>
    </div>

    <script>
        let universityName = '';
        let staffId = '';

        function setCredentials() {
            universityName = document.getElementById('universityInput').value;
            staffId = document.getElementById('staffIdInput').value;
            if (universityName && staffId) {
                fetchRequests();
            } else {
                showAlert('Please enter both university name and staff ID');
            }
        }

        async function fetchRequests() {
            if (!universityName || !staffId) {
                showAlert('Please set both university name and staff ID first');
                return;
            }

            try {
                const response = await fetch('https://zs1hgwqx03.execute-api.us-east-1.amazonaws.com/default/admin-handler', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'fetch_staff_requests',
                        universityName: universityName,
                        staffId: staffId
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                displayRequests(data.requests);
            } catch (error) {
                console.error('Error fetching requests:', error);
                showAlert('Failed to fetch requests: ' + error.message);
            }
        }

        function displayRequests(requestsString) {
            const requestList = document.getElementById('requestList');
            requestList.innerHTML = '';

            if (!requestsString || requestsString.length === 0) {
                requestList.innerHTML = '<div class="no-requests">No pending requests</div>';
                return;
            }

            const requests = requestsString.split('|');
            const currentTime = Math.floor(Date.now() / 1000);
            let hasValidRequests = false;

            // remove trailing empty item caused by trailing "|"
            if (requests[requests.length - 1] === '') {
                requests.pop();
            }

            for (let i = 0; i < requests.length; i += 3) {
                const studentId = requests[i];
                const timestamp = parseInt(requests[i + 1]);
                const studentName = requests[i + 2];

                // Check if request is within the last 15 minutes
                if (studentId && timestamp && studentName && (currentTime - timestamp <= 900)) {
                    hasValidRequests = true;
                    const requestTime = new Date(timestamp * 1000);
                    const formattedTime = requestTime.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });

                    const requestItem = document.createElement('div');
                    requestItem.className = 'request-item';
                    requestItem.innerHTML = `
                        <div><strong>${studentName}</strong> requested access at ${formattedTime}.</div>
                        <div class="request-actions">
                            <button class="approve-button" onclick="handleRequest('${studentId}', 'approve')">Approve</button>
                            <button class="deny-button" onclick="handleRequest('${studentId}', 'deny')">Deny</button>
                        </div>
                    `;
                    requestList.appendChild(requestItem);
                }
            }

            if (!hasValidRequests) {
                requestList.innerHTML = '<div class="no-requests">No pending requests</div>';
            }
        }

        async function handleRequest(studentId, action) {
            try {
                const response = await fetch('https://zs1hgwqx03.execute-api.us-east-1.amazonaws.com/default/admin-handler', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'handle_staff_request',
                        universityName: universityName,
                        studentId: studentId,
                        requestAction: action,
                        staffId: staffId
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                // show alert
                if (action === 'approve') {
                    showAlert('Request approved successfully');
                } else {
                    showAlert('Request denied successfully');
                }

                fetchRequests();  // Refresh the list
            } catch (error) {
                console.error('Error handling request:', error);
                showAlert(`Failed to ${action} request: ` + error.message);
            }
        }

        // Add event listener for the reload button
        document.getElementById('reloadButton').addEventListener('click', () => {
            if (universityName && staffId) {
                fetchRequests();
            } else {
                showAlert('Please set both university name and staff ID first');
            }
        });
    </script>
</body>
</html>