<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduAuth MFA</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <script src="./show_alert.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('./Inter.woff2') format('woff2');
        }

        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('./Inter.woff2') format('woff2');
        }

        :root {
            --bg-color-1: #7ab2ff;
            --bg-color-2: #609dff;
            --bg-color-3: #3b86ff;
            --bg-color-4: #0062ff;
            --card-color-1: #f8649e;
            --card-color-2: #f03d81;
            --card-color-3: #e81664;
            --card-color-4: #c70953;
        }

        .new-user-content {
            padding: 20px;
            text-align: center;
        }

        .new-user-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .new-user-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 5px;
        }

        .new-user-submit {
            width: 100%;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px;
        }

        .new-user-submit:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .logo {
            max-height: 60px;
            max-width: 100%;
            width: auto;
            height: auto;
            display: block;
        }

        .logo-container {
            padding: 20px 40px 10px;
            text-align: center;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .perspective-container {
            perspective: 1000px;
            transform: translateZ(0);
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 50px 0;
        }

        .mfa-card {
            cursor: default;
            position: relative;
            width: 320px;
            height: 478px;
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: #fff;
            background: radial-gradient(circle at left, var(--card-color-1) 35%, var(--card-color-2) 35%, var(--card-color-2) 50%, var(--card-color-3) 50%, var(--card-color-3) 65%, var(--card-color-4) 65%, var(--card-color-4) 80%, var(--card-color-4) 80%);
            transition: transform 1s ease, opacity 1s ease-in-out;
            transform-style: preserve-3d;
            transform: rotateY(-360deg) translateY(100vh);
            opacity: 0;
            border-radius: 20px;
        }

        .spin {
            transform: rotateY(0deg) translateY(0);
            opacity: 1;
        }

        .mfa-card-flipped {
            transform: rotateY(180deg);
        }

        .mfa-side {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        .mfa-front {
            z-index: 2;
            transform: rotateY(0deg);
        }

        .mfa-back {
            transform: rotateY(180deg);
            padding: 20px;
            box-sizing: border-box;
        }

        #mfaContent {
            max-width: 280px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .mfa-options-container {
            padding: 0 20px;
        }

        .mfa-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.5s ease;
            text-align: left;
            border-radius: 6px;
        }

        .mfa-option.unconfigured {
            opacity: 0.6;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .mfa-option.unconfigured:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.2);
        }

        .mfa-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .mfa-option:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .mfa-option:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .instructor-section {
            margin-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 10px;
        }

        .instructor-text {
            color: #fff;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .back-button-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
        }

        .back-button {
            padding: 8px 16px;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .mfa-input {
            width: 100%;
            padding: 8px 0;
            background-color: transparent;
            border: none;
            color: #fff;
            border-bottom: 1px solid currentColor;
            font-size: 1em;
            outline: none;
            margin-bottom: 10px;
        }

        .mfa-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .mfa-submit {
            width: 100%;
            border: 1px solid #fff;
            padding: 10px;
            margin-top: 10px;
            color: #fff;
            background-color: transparent;
            text-transform: uppercase;
            border-radius: 20px;
            cursor: pointer;
        }

        .mfa-submit:hover,
        .mfa-submit:focus {
            outline: none;
            background-color: #fff;
            color: var(--card-color-4);
        }

        .warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f44336;
            color: #fff;
            padding: 15px;
            text-align: center;
            z-index: 1000;
        }

        .school-name-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .school-name-input {
            padding: 10px;
            font-size: 16px;
            width: 300px;
            margin-bottom: 10px;
        }

        .school-name-submit {
            padding: 10px 20px;
            font-size: 16px;
            background-color: var(--bg-color-3);
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .school-name-error {
            color: #f44336;
            margin-top: 10px;
        }

        .prompt-title {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .code-input-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .code-input {
            width: 30px;
            height: 40px;
            text-align: center;
            font-size: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 5px;
            font-family: 'Inter';
        }

        .code-input:focus {
            outline: none;
            border-color: #fff;
        }

        .redirect-checkbox {
            position: absolute;
            bottom: 18px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 13px;
        }

        .redirect-checkbox input {
            margin-right: 10px;
        }

        #background, #new-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 1s ease-in-out;
            z-index: -1;
        }

        #background {
            background: radial-gradient(circle at bottom, var(--bg-color-1) 20%, var(--bg-color-2) 20%, var(--bg-color-2) 28%, var(--bg-color-3) 28%, var(--bg-color-3) 36%, var(--bg-color-4) 36%, var(--bg-color-4) 44%, var(--bg-color-4) 44%);
        }

        #new-background {
            opacity: 0;
        }

        .session-expired {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            color: #fff;
        }

        .start-new-session-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .start-new-session-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .fade-out {
            opacity: 0;
            transition: opacity 0.25s ease-out;
        }

        .fade-in {
            opacity: 1;
            transition: opacity 0.25s ease-in;
        }
    </style>
</head>
<body>
    <div id="background"></div>
    <div id="new-background"></div>
    <div class="perspective-container">
        <div id="mfaCard" class="mfa-card">
            <div class="mfa-side mfa-front">
                <div class="logo-container">
                    <img id="universityLogo" alt="Logo" class="logo" draggable="false"/>
                </div>
                <div id="mfaOptionsSection" class="mfa-options-container">
                    <div class="section-title">Choose <span id="numberOfMethods"></span> authentication <span id="methodPlurality">method</span></div>
                    <div id="standardMfaOptions">
                        <button id="emailMfaOption" class="mfa-option" onclick="MFAOptionClick('email')">
                            <img src="email-icon.svg" alt="Email Icon" class="mfa-icon">
                            Email
                        </button>
                        <button id="pushMfaOption" class="mfa-option" onclick="MFAOptionClick('push')">
                            <img src="push-notification-icon.svg" alt="Push Notification Icon" class="mfa-icon">
                            Push notification
                        </button>
                        <button id="smsMfaOption" class="mfa-option" onclick="MFAOptionClick('sms')">
                            <img src="square_message_icon.svg" alt="SMS Icon" class="mfa-icon">
                            Text message
                        </button>
                        <button id="totpMfaOption" class="mfa-option" onclick="MFAOptionClick('totp')">
                            <img src="qr-code-icon.svg" alt="TOTP Icon" class="mfa-icon">
                            Authenticator code
                        </button>
                    </div>
                    <div id="instructorOptionSection" class="instructor-section">
                        <div class="instructor-text">Unable to authenticate? Ask your teacher to authenticate for you.</div>
                        <button id="instructorMfaOption" class="mfa-option" onclick="MFAOptionClick('instructor')">
                            <img src="alert_teacher.svg" alt="Alert Teacher Icon" class="mfa-icon">
                            Ask instructor
                        </button>
                    </div>
                </div>
                <div class="redirect-checkbox">
                    <input type="checkbox" id="redirectCheckbox" onchange="redirectCheckboxUpdate()"  checked>
                    <div>Redirect after authenticating</div>
                </div>
            </div>
            <div class="mfa-side mfa-back">
                <div id="mfaContent"></div>
                <div class="back-button-container">
                    <button class="back-button" onclick="flipCard()">Back</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userInfo = null;
        let numberOfMethodsRequired;
        let completedMethods = 0;
        let shouldRedirect = true;
        let teacherEmail = '';
        let cardSide;
        let sessionTimer;
        let isSessionExpired = false;
        let isAuthenticated = false;

        // parse query params (university, session_id, redirect_url, login_url)
        let universityGlobal = '';
        let sessionIdGlobal = '';
        let redirectUrl = '';
        let loginUrl = '';

        let maxSessionTime;
        let debug_mode = true;
        let minimumOrgMethodsRequired;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            university = urlParams.get('university');
            sessionId = urlParams.get('session_id');
            redirectUrl = urlParams.get('redirect_url') || '';
            loginUrl = urlParams.get('login_url') || '';

            universityGlobal = university;
            sessionIdGlobal = sessionId;

            if (university && sessionId) {
                fetchUserInfo();
            } else {
                showAlert('Missing required URL parameters');
            }
        });

        function clearSessionTimer() {
            if (sessionTimer) {
                clearTimeout(sessionTimer);
                sessionTimer = null;
            }
        }

        function expireSession() {
            console.log('called expireSession');
            isSessionExpired = true;
            clearTimeout(sessionTimer);

            const mfaCard = document.getElementById('mfaCard');

            // First, ensure the card is flipped to the front
            flipCardTo('front');

            mfaCard.classList.add('fade-out');

            // When fade out is complete, swap the content and fade back in
            setTimeout(() => {
                // Hide all content
                document.getElementById('mfaOptionsSection').style.display = 'none';
                document.getElementById('mfaContent').style.display = 'none';
                document.querySelector('.redirect-checkbox').style.display = 'none';

                // Show session expired message and button
                mfaCard.innerHTML = `
                    <div class="session-expired">
                        <h2>Session expired</h2>
                        <p>Your session has timed out due to inactivity.</p>
                        <button class="start-new-session-btn" onclick="startNewSession()">Start new session</button>
                    </div>
                `;

                // Remove the flip animation class if it's still there
                mfaCard.classList.remove('mfa-card-flipped');

                // Start fade in
                mfaCard.classList.remove('fade-out');
                mfaCard.classList.add('fade-in');

                // Remove the fade-in class after animation completes
                setTimeout(() => {
                    mfaCard.classList.remove('fade-in');
                }, 250);
            }, 250); // This should match the fade-out transition duration
        }

        // Reload the page to start a new session
        function startNewSession() {
            window.location.href = loginUrl;
        }

        async function fetchUserInfo() {
            try {
                const response = await fetch(`https://depolnesattx7tqqbmeakxeso40utyss.lambda-url.us-east-1.on.aws?university=${universityGlobal}&sessionId=${sessionIdGlobal}`);
                const data = await response.json();

                console.log('Response from backend:', data);

                // only use the university's default redirect url if one isn't set in the query params
                if (!redirectUrl) {
                    redirectUrl = data.redirectUrl;
                }

                // only use the university's default login url if one isn't set in the query params
                if (!loginUrl) {
                    loginUrl = data.loginUrl;
                }

                console.log('Redirect URL:', redirectUrl);
                console.log('Login URL:', loginUrl);

                document.getElementById('universityLogo').src = `https://uni-logos.s3.amazonaws.com/${universityGlobal}`;

                if (data.error) {
                    console.log('Error occured while fetching user info.');
                    if (data.error == 'USER_NOT_FOUND') {
                        handleNewUser(universityGlobal, sessionId);
                    } else if (data.error == 'SESSION_EXPIRED') {
                        // redirect to the login page
                        window.location.href = loginUrl;
                    } else {
                        console.log('Error fetching user info:', data.error);
                        showAlert('Failed to fetch user information.');

                        // Even if there's an error, we still want to show the card
                        document.getElementById('mfaCard').classList.add("spin");
                    }
                } else if (data.isAuthenticated && data.isAuthenticated.toString() == 'true') {
                    console.log('User is already authenticated');
                    if (debug_mode) {
                        console.log('Redirecting to:', redirectUrl);
                    } else {
                        goToRedirectUrl();
                    }
                } else {
                    applySchoolColors(data.colors);
                    maxSessionTime = data.maxSessionTime;
                    minimumOrgMethodsRequired = data.minimumOrgMethodsRequired;
                    userInfo = data;
                    numberOfMethodsRequired = Math.max(data.minimumMethodsRequired, data.minimumOrgMethodsRequired);
                    console.log('Number of methods required:', numberOfMethodsRequired);
                    updateMethodText();
                    updateMFAOptions();

                    // Trigger the animation after fetching user info
                    document.getElementById('mfaCard').classList.add("spin");

                    sessionTimer = setTimeout(() => {
                        expireSession();
                    }, maxSessionTime * 1000); // Convert to milliseconds
                }
            } catch (error) {
                console.log('Error fetching user info:', error);
                showAlert('Failed to fetch user information.');
            }
        }

        function setupCodeInput(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.getElementsByClassName('code-input');

            container.addEventListener('paste', handlePaste);

            function checkAndVerifyOrFocusFirst() {
                const allFilled = Array.from(inputs).every(input => input.value.length === 1);
                if (allFilled) {
                    if (containerId === 'emailVerificationCodeInputContainer') {
                        verifyNewEmailAddress();
                    } else if (containerId === 'setupTotpCodeInputContainer') {
                        verifyMFA('totp');
                    } else {
                        verifyMFA(containerId.replace('CodeInputContainer', ''));
                    }
                } else {
                    const firstEmpty = Array.from(inputs).find(input => input.value.length === 0);
                    if (firstEmpty) {
                        firstEmpty.focus();
                    }
                }
            }

            for (let i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('input', function(e) {
                    if (this.value.length === this.maxLength) {
                        const allFilled = Array.from(inputs).every(input => input.value.length === 1);
                        if (allFilled) {
                            console.log('In setupCodeInput function for', containerId.replace('CodeInputContainer', ''));
                            if (containerId.replace('CodeInputContainer', '') === 'setupTotp') {
                                verifyMFA('totp');
                            } else if (containerId === 'emailVerificationCodeInputContainer') {
                                verifyNewEmailAddress();
                            } else {
                                verifyMFA(containerId.replace('CodeInputContainer', ''));
                            }
                        } else if (i === inputs.length - 1) {
                            const firstEmpty = Array.from(inputs).find(input => input.value.length === 0);
                            if (firstEmpty) {
                                firstEmpty.focus();
                            }
                        } else if (i < inputs.length - 1) {
                            inputs[i + 1].focus();
                        }
                    }
                });

                inputs[i].addEventListener('keydown', function(e) {
                    switch(e.key) {
                        case 'Backspace':
                            if (this.value.length === 0 && i > 0) {
                                inputs[i - 1].focus();
                            }
                            break;
                        case 'ArrowLeft':
                            if (i > 0) {
                                e.preventDefault();
                                inputs[i - 1].focus();
                            }
                            break;
                        case 'ArrowRight':
                            if (i < inputs.length - 1) {
                                e.preventDefault();
                                inputs[i + 1].focus();
                            }
                            break;
                    }
                });

                inputs[i].addEventListener('focus', function() {
                    this.select();
                });

                inputs[i].addEventListener('keypress', function(e) {
                    const charCode = e.which ? e.which : e.keyCode;
                    if (charCode < 48 || charCode > 57) {
                        e.preventDefault();
                        return false;
                    }
                    return true;
                });
            }

            inputs[0].focus();
        }

        function handlePaste(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const inputs = e.currentTarget.getElementsByClassName('code-input');
            const startIndex = parseInt(document.activeElement.dataset.index);

            for (let i = 0; i < inputs.length - startIndex; i++) {
                if (i < paste.length && /^\d+$/.test(paste[i])) {
                    inputs[startIndex + i].value = paste[i];
                }
            }

            const allFilled = Array.from(inputs).every(input => input.value.length === 1);

            if (allFilled) {
                console.log('In handlePaste function for', e.currentTarget.id.replace('CodeInputContainer', ''));
                if (e.currentTarget.id.replace('CodeInputContainer', '') == 'setupTotp') {
                    verifyMFA('totp');
                } else if (e.currentTarget.id == 'emailVerificationCodeInputContainer') {
                    verifyNewEmailAddress();
                } else {
                    verifyMFA(e.currentTarget.id.replace('CodeInputContainer', ''));
                }
            } else {
                for (let i = 0; i < inputs.length; i++) {
                    if (inputs[i].value === '') {
                        inputs[i].focus();
                        break;
                    }
                    if (i === inputs.length - 1) {
                        inputs[i].focus();
                    }
                }
            }
        }

        function updateMethodText() {
            const methodSpan = document.getElementById('methodPlurality');
            if (numberOfMethodsRequired > 1) {
                methodSpan.textContent = 'methods';
            } else {
                methodSpan.textContent = 'method';
            }
            document.getElementById('numberOfMethods').textContent = numberOfMethodsRequired;
        }

        function goToRedirectUrl() {
            // Replace this with the actual redirect URL
            if (shouldRedirect) {
                console.log('Not redirecting to:', redirectUrl);
            } else {
                window.location.href = redirectUrl;
            }
        }

        function absoluteRedirect() {
            window.location.href = redirectUrl;
        }

        function updateMFAOptions() {
            const standardMfaOptions = document.getElementById('standardMfaOptions');
            const instructorOption = document.getElementById('instructorMfaOption');

            if (!shouldRedirect && completedMethods >= numberOfMethodsRequired) {
                // Authentication approved and redirect unchecked
                standardMfaOptions.innerHTML = `
                    <button id="emailConfigOption" class="mfa-option" onclick="MFAOptionClick('emailConfig')">
                        <img src="email-icon.svg" alt="Email Icon" class="mfa-icon">
                        Email
                    </button>
                    <button id="pushConfigOption" class="mfa-option" onclick="MFAOptionClick('pushConfig')">
                        <img src="push-notification-icon.svg" alt="Push Notification Icon" class="mfa-icon">
                        Push notification
                    </button>
                    <button id="smsConfigOption" class="mfa-option" onclick="MFAOptionClick('smsConfig')">
                        <img src="square_message_icon.svg" alt="SMS Icon" class="mfa-icon">
                        Text message
                    </button>
                    <button id="totpConfigOption" class="mfa-option ${!userInfo.hasEmail ? 'unconfigured' : ''}" onclick="MFAOptionClick('totpConfig')">
                        <img src="qr-code-icon.svg" alt="TOTP Icon" class="mfa-icon">
                        Authenticator code
                    </button>
                `;

                instructorOption.innerHTML = `
                    <img src="redirect-icon.svg" alt="Redirect Icon" class="mfa-icon">
                    Go to redirect URL
                `;
                instructorOption.onclick = absoluteRedirect;

                // Update the instructor text
                document.getElementsByClassName('instructor-text')[0].textContent = 'All authentication methods have been approved. You can now proceed to the redirect URL.';

                // Update the section title
                document.querySelector('#mfaOptionsSection .section-title').textContent = 'Configure your authentication methods';
            } else {
                // Original behavior
                standardMfaOptions.innerHTML = `
                    <button id="emailMfaOption" class="mfa-option ${!userInfo.hasEmail ? 'unconfigured' : ''}" onclick="MFAOptionClick('email')">
                        <img src="email-icon.svg" alt="Email Icon" class="mfa-icon">
                        Email
                    </button>
                    <button id="pushMfaOption" class="mfa-option ${!userInfo.hasPushNotification ? 'unconfigured' : ''}" onclick="MFAOptionClick('push')">
                        <img src="push-notification-icon.svg" alt="Push Notification Icon" class="mfa-icon">
                        Push notification
                    </button>
                    <button id="smsMfaOption" class="mfa-option ${!userInfo.hasPhone ? 'unconfigured' : ''}" onclick="MFAOptionClick('sms')">
                        <img src="square_message_icon.svg" alt="SMS Icon" class="mfa-icon">
                        Text message
                    </button>
                    <button id="totpMfaOption" class="mfa-option ${!userInfo.hasEmail || !userInfo.hasTOTP ? 'unconfigured' : ''}" onclick="MFAOptionClick('totp')">
                        <img src="qr-code-icon.svg" alt="TOTP Icon" class="mfa-icon">
                        Authenticator code
                    </button>
                `;

                instructorOption.innerHTML = `
                    <img src="alert_teacher.svg" alt="Alert Teacher Icon" class="mfa-icon">
                    Ask instructor
                `;
                instructorOption.onclick = () => MFAOptionClick('instructor');

                // Keep the original section title
                document.querySelector('#mfaOptionsSection .section-title').innerHTML = `Choose <span id="numberOfMethods">${numberOfMethodsRequired}</span> authentication <span id="methodPlurality">${numberOfMethodsRequired > 1 ? 'methods' : 'method'}</span>`;
            }
        }

        // when mfa option is clicked, fill the back of the card with the relevant content
        function MFAOptionClick(method) {
            if (method === 'totp' && !userInfo.hasEmail) {
                showAlert('You must configure email first before setting up an authenticator app.');
                return;
            }

            flipCardTo('back');
            const mfaContent = document.getElementById('mfaContent');
            mfaContent.innerHTML = '';

            const authMethodDisplayNames = {
                'sms': 'Text message',
                'email': 'Email',
                'push': 'Push notification',
                'totp': 'Authenticator code',
                'instructor': 'Ask instructor',
                'smsConfig': 'Configure Text message',
                'emailConfig': 'Configure Email',
                'pushConfig': 'Configure Push notification',
                'totpConfig': 'Configure Authenticator code'
            };

            let chosenMethod = authMethodDisplayNames[method];

            switch (method) {
                case 'sms':
                    mfaContent.innerHTML = `
                        <div class="section-title">${chosenMethod}</div>
                        <div class="instructor-text">A code has been sent to your registered phone number.</div>
                        <div id="smsCodeInputContainer" class="code-input-container">
                            <input type="text" maxlength="1" class="code-input" data-index="0">
                            <input type="text" maxlength="1" class="code-input" data-index="1">
                            <input type="text" maxlength="1" class="code-input" data-index="2">
                            <input type="text" maxlength="1" class="code-input" data-index="3">
                            <input type="text" maxlength="1" class="code-input" data-index="4">
                            <input type="text" maxlength="1" class="code-input" data-index="5">
                        </div>
                        <div id="verificationStatus"></div>
                    `;
                    setupCodeInput('smsCodeInputContainer');
                    sendSMSCode();
                    break;
                case 'email':
                    mfaContent.innerHTML = `
                        <div class="section-title">${chosenMethod}</div>
                        <div class="instructor-text">A verification code has been sent to your email.</div>
                        <div id="emailCodeInputContainer" class="code-input-container">
                            <input type="text" maxlength="1" class="code-input" data-index="0">
                            <input type="text" maxlength="1" class="code-input" data-index="1">
                            <input type="text" maxlength="1" class="code-input" data-index="2">
                            <input type="text" maxlength="1" class="code-input" data-index="3">
                            <input type="text" maxlength="1" class="code-input" data-index="4">
                            <input type="text" maxlength="1" class="code-input" data-index="5">
                        </div>
                        <div id="verificationStatus"></div>
                    `;
                    setupCodeInput('emailCodeInputContainer');
                    sendEmailCode();
                    break;
                case 'push':
                    mfaContent.innerHTML = `
                        <div class="section-title">${chosenMethod}</div>
                        <div class="instructor-text">A verification code has been sent to your phone via push notification.</div>
                        <div id="pushCodeInputContainer" class="code-input-container">
                            <input type="text" maxlength="1" class="code-input" data-index="0">
                            <input type="text" maxlength="1" class="code-input" data-index="1">
                            <input type="text" maxlength="1" class="code-input" data-index="2">
                            <input type="text" maxlength="1" class="code-input" data-index="3">
                            <input type="text" maxlength="1" class="code-input" data-index="4">
                            <input type="text" maxlength="1" class="code-input" data-index="5">
                        </div>
                        <div id="verificationStatus"></div>
                    `;
                    setupCodeInput('pushCodeInputContainer');
                    sendPushNotification();
                    break;
                case 'totp':
                    if (userInfo.hasTOTP) {
                        mfaContent.innerHTML = `
                            <div class="section-title">${chosenMethod}</div>
                            <div id="totpCodeInputContainer" class="code-input-container">
                                <input type="text" maxlength="1" class="code-input" data-index="0">
                                <input type="text" maxlength="1" class="code-input" data-index="1">
                                <input type="text" maxlength="1" class="code-input" data-index="2">
                                <input type="text" maxlength="1" class="code-input" data-index="3">
                                <input type="text" maxlength="1" class="code-input" data-index="4">
                                <input type="text" maxlength="1" class="code-input" data-index="5">
                            </div>
                            <div id="verificationStatus"></div>
                        `;
                        setupCodeInput('totpCodeInputContainer');
                    } else {
                        setupTOTP();
                    }
                    break;
                case 'instructor':
                    mfaContent.innerHTML = `
                        <div class="section-title">${chosenMethod}</div>
                        <div class="instructor-text">Enter your teacher's email to request authentication.</div>
                        <input type="email" id="teacherEmail" class="mfa-input" placeholder="Teacher's email">
                        <button onclick="requestInstructorApproval()" class="mfa-submit">Send Request</button>
                    `;
                    break;
                case 'smsConfig':
                    mfaContent.innerHTML = `
                        <div class="section-title">${chosenMethod}</div>
                        <input type="tel" id="phoneNumber" class="mfa-input" placeholder="Enter your phone number">
                        <button onclick="updatePhoneNumber()" class="mfa-submit">Update Phone Number</button>
                    `;
                    break;
                case 'emailConfig':
                    mfaContent.innerHTML = `
                        <div class="section-title">${chosenMethod}</div>
                        <input type="email" id="emailAddress" class="mfa-input" placeholder="Enter your email address">
                        <button onclick="updateEmailAddress()" class="mfa-submit">Update Email Address</button>
                    `;
                    break;
                case 'pushConfig':
                    mfaContent.innerHTML = `
                        <div class="section-title">${chosenMethod}</div>
                        <div class="instructor-text">To configure push notifications, please install our mobile app and scan the QR code below.</div>
                        <div id="pushQRCode"></div>
                        <button onclick="configurePushNotifications()" class="mfa-submit">Generate QR Code</button>
                    `;
                    break;
                case 'totpConfig':
                    setupTOTP();
                    break;
            }
        }

        async function updatePhoneNumber() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_phone_number',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal,
                        phoneNumber: phoneNumber
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                showAlert('Phone number updated successfully.');
                userInfo.hasPhone = true;
                flipCardTo('front');
                updateMFAOptions();
            } catch (error) {
                console.log('Error updating phone number:', error);
                showAlert('Failed to update phone number: ' + error.message);
            }
        }

        async function updateEmailAddress() {
            const emailAddress = document.getElementById('emailAddress').value;
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_email_address',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal,
                        email: emailAddress
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                showAlert('Verification code sent to your new email address.');
                
                // Fade out the email input and submit button
                const emailInput = document.getElementById('emailAddress');
                const submitButton = document.querySelector('.mfa-submit');
                emailInput.style.transition = 'opacity 0.25s';
                submitButton.style.transition = 'opacity 0.25s';
                emailInput.style.opacity = '0';
                submitButton.style.opacity = '0';
                
                // After fade out, replace with verification code input
                setTimeout(() => {
                    const mfaContent = document.getElementById('mfaContent');
                    mfaContent.innerHTML = `
                        <div class="section-title">Verify Email</div>
                        <div class="instructor-text">Enter the 6-digit code sent to ${emailAddress}</div>
                        <div id="emailVerificationCodeInputContainer" class="code-input-container">
                            <input type="text" maxlength="1" class="code-input" data-index="0">
                            <input type="text" maxlength="1" class="code-input" data-index="1">
                            <input type="text" maxlength="1" class="code-input" data-index="2">
                            <input type="text" maxlength="1" class="code-input" data-index="3">
                            <input type="text" maxlength="1" class="code-input" data-index="4">
                            <input type="text" maxlength="1" class="code-input" data-index="5">
                        </div>
                    `;
                    setupCodeInput('emailVerificationCodeInputContainer');
                }, 250);
            } catch (error) {
                console.log('Error updating email address:', error);
                showAlert('Failed to update email address: ' + error.message);
            }
        }

        async function verifyNewEmailAddress() {
            const inputs = document.getElementsByClassName('code-input');
            const code = Array.from(inputs).map(input => input.value).join('');

            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'verify_code',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal,
                        code: code,
                        method: 'updating_email'
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                showAlert('Email address verified and updated successfully.');
                userInfo.hasEmail = true;
                flipCardTo('front');
                updateMFAOptions();
            } catch (error) {
                console.log('Error verifying new email address:', error);
                showAlert('Failed to verify new email address: ' + error.message);
            }
        }

        async function configurePushNotifications() {
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: '',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Generate QR code using the received data
                const qr = qrcode(0, 'L');
                qr.addData(data.qrCodeData);
                qr.make();
                
                const qrImage = qr.createImgTag(5);
                document.getElementById('pushQRCode').innerHTML = qrImage;
                
                showAlert('Scan the QR code with your mobile app to set up push notifications.');
                userInfo.hasPushNotification = true;
                updateMFAOptions();
            } catch (error) {
                console.log('Error generating push QR code:', error);
                showAlert('Failed to generate push QR code: ' + error.message);
            }
        }

        function setupTOTP() {
            const mfaContent = document.getElementById('mfaContent');
            mfaContent.innerHTML = `
                <div class="section-title">Setup Authenticator</div>
                <div id="qrcode"></div>
                <div class="instructor-text">Scan the QR code with your authenticator app</div>
                <div id="setupTotpCodeInputContainer" class="code-input-container">
                    <input type="text" maxlength="1" class="code-input" data-index="0">
                    <input type="text" maxlength="1" class="code-input" data-index="1">
                    <input type="text" maxlength="1" class="code-input" data-index="2">
                    <input type="text" maxlength="1" class="code-input" data-index="3">
                    <input type="text" maxlength="1" class="code-input" data-index="4">
                    <input type="text" maxlength="1" class="code-input" data-index="5">
                </div>
            `;
            setupCodeInput('setupTotpCodeInputContainer');
            generateTOTPQRCode();
        }

        async function generateTOTPQRCode() {
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'generate_totp_secret',
                        sessionId: sessionIdGlobal,
                        university: universityGlobal
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                // Extract the secret from the otpauth URL
                const secret = new URL(data.otpauth_url).searchParams.get('secret');

                // Generate QR code
                const qr = qrcode(0, 'L');
                qr.addData(data.otpauth_url);
                qr.make();

                // Create QR code image
                const qrImage = qr.createImgTag(5);

                // Update the layout
                const mfaContent = document.getElementById('mfaContent');
                mfaContent.innerHTML = `
                    <div class="section-title" style="margin-bottom: 15px;">Setup Authenticator</div>
                    <div id="qrcode" style="text-align: center; margin-bottom: 15px;">${qrImage}</div>
                    <div class="instructor-text">Scan the QR code with your authenticator app, or manually enter this secret:</div>
                    <div style="display: flex; justify-content: center; width: 100%;">
                        <div style="display: flex; justify-content: center; align-items: stretch; margin-bottom: 10px;">
                            <button id="toggleSecretBtn" class="mfa-option" style="width: 56px; text-align: center; padding: 4px 10px; margin-right: 10px; display: flex; justify-content: center; align-items: center;">Show</button>
                            <div id="secretContainer" style="flex-grow: 1; display: flex; align-items: center;">
                            <div id="secretSpan" style="word-break: break-all; text-align: center; width: 180px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; padding: 2px; height: 2.6em; line-height: 1.3em; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 12px;">••••••••••••••••</div>
                            </div>
                        </div>
                    </div>
                    <div id="setupTotpCodeInputContainer" class="code-input-container" style="margin-bottom: 0px;">
                        <input type="text" maxlength="1" class="code-input" data-index="0">
                        <input type="text" maxlength="1" class="code-input" data-index="1">
                        <input type="text" maxlength="1" class="code-input" data-index="2">
                        <input type="text" maxlength="1" class="code-input" data-index="3">
                        <input type="text" maxlength="1" class="code-input" data-index="4">
                        <input type="text" maxlength="1" class="code-input" data-index="5">
                    </div>
                `;
                setupCodeInput('setupTotpCodeInputContainer');

                // Set QR code size
                const qrCodeImg = document.querySelector('#qrcode img');
                qrCodeImg.style.width = '180px';
                qrCodeImg.style.height = '180px';

                // Add click event to reveal/hide secret
                const secretSpan = document.getElementById('secretSpan');
                const toggleSecretBtn = document.getElementById('toggleSecretBtn');
                let secretVisible = false;

                function toggleSecret() {
                    if (secretVisible) {
                        secretSpan.textContent = '••••••••••••••••';
                        toggleSecretBtn.textContent = 'Show';
                        secretVisible = false;
                    } else {
                        secretSpan.textContent = secret;
                        toggleSecretBtn.textContent = 'Hide';
                        secretVisible = true;
                    }
                }

                toggleSecretBtn.addEventListener('click', toggleSecret);
            } catch (error) {
                console.log('Error generating TOTP QR code:', error);
                showAlert('Failed to generate TOTP QR code: ' + error.message);
            }
        }

        async function verifyMFA(method) {
            console.log('Verifying MFA method:', method);
            switch (method) {
                case 'email':
                case 'sms':
                case 'push':
                case 'totp':
                    await verifyCodeMFA(method);
                    break;
                default:
                    showAlert('Invalid MFA method');
            }
        }

        async function verifyCodeMFA(method) {
            const inputs = document.getElementsByClassName('code-input');
            const code = Array.from(inputs).map(input => input.value).join('');

            console.log('Verifying code:', code);
            console.log('Method:', method);

            // Disable inputs
            Array.from(inputs).forEach(input => input.disabled = true);

            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'verify_code',
                        method: method,
                        code,
                        sessionId: sessionIdGlobal,
                        university: universityGlobal
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.verified) {
                    completedMethods++;
                    userInfo[`completed${method.charAt(0).toUpperCase() + method.slice(1)}`] = true;
                    isAuthenticated = (completedMethods >= numberOfMethodsRequired) || isAuthenticated;
                    if (!isAuthenticated) {
                        if (method == 'totp') {
                            showAlert(`Authenticator code verified successfully. (${completedMethods}/${numberOfMethodsRequired})`);
                        } else {
                            showAlert(`${method.charAt(0).toUpperCase() + method.slice(1)} verified successfully. (${completedMethods}/${numberOfMethodsRequired})`);
                        }
                    }

                    if (completedMethods >= numberOfMethodsRequired && !isAuthenticated) {
                        await sendUniversityAuthentication();
                    } else {
                        flipCard();
                        updateMFAOptions();
                    }
                } else {
                    showAlert(`${method.charAt(0).toUpperCase() + method.slice(1)} verification failed. Please try again.`);
                    // Clear and re-enable inputs
                    Array.from(inputs).forEach(input => {
                        input.value = '';
                        input.disabled = false;
                    });
                    inputs[0].focus();
                }
            } catch (error) {
                console.log(`Error verifying ${method} MFA:`, error);
                if (error.message == 'INVALID_CODE') {
                    showAlert('Wrong code. Please try again.');
                } else if (error.message == 'MAX_ATTEMPTS_REACHED') {
                    showAlert(`Maximum attempts reached. Send a new ${method} code or verify through other methods.`);
                    setTimeout(() => flipCard(), 2000);
                } else {
                    showAlert(`Failed to verify ${method} MFA: ` + error.message);
                    setTimeout(() => flipCard(), 2000);
                }
                // Clear and re-enable inputs
                Array.from(inputs).forEach(input => {
                    input.value = '';
                    input.disabled = false;
                });
                inputs[0].focus();
            }
        }

        async function sendUniversityAuthentication() {
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'complete_authentication',
                        sessionId: sessionIdGlobal, 
                        university: universityGlobal 
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    console.log('Error sending university authentication:', data.error);
                    showAlert('Failed to complete authentication.');
                } else {
                    showAlert('Authentication successful.');
                    clearSessionTimer(); // Clear the session timer
                    if (shouldRedirect) {
                        if (debug_mode) {
                            console.log('Redirecting to:', redirectUrl);
                        } else {
                            goToRedirectUrl();
                        }
                    } else {
                        flipCard();
                        console.log('Updating MFA options for non-redirect');
                        updateMFAOptions();
                    }
                }
            } catch (error) {
                console.log('Error sending university authentication:', error);
                showAlert('Failed to complete authentication: ' + error.message);
            }
        }

        function handleNewUser(university, sessionId) {
            console.log('New user detected');
            const mfaOptionsSection = document.getElementById('mfaOptionsSection');
            mfaOptionsSection.innerHTML = `
                <div class="new-user-content">
                    <div class="new-user-title">New User Registration</div>
                    <input type="email" id="newUserEmail" class="new-user-input" placeholder="Enter your email">
                    <button onclick="submitNewUser()" class="new-user-submit">Submit</button>
                </div>
            `;
        }

        async function submitNewUser() {
            const email = document.getElementById('newUserEmail').value;
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'register_new_user',
                        university: universityGlobal, 
                        sessionId: sessionIdGlobal, 
                        email 
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                showAlert('Registration successful. Please try logging in again.');
                // update the page's url parameters
                if (redirectUrl = '') {
                    window.location.href = `#${universityGlobal},${sessionIdGlobal},${redirectUrl}`;
                } else {
                    window.location.href = `#${universityGlobal},${sessionIdGlobal}`;
                }
                // Reload the page or redirect to login
                window.location.reload();
            } catch (error) {
                console.log('Error registering new user:', error);
                showAlert('Failed to register: ' + error.message);
            }
        }

        function flipCard() {
            if (document.getElementById('mfaCard').classList.contains('mfa-card-flipped')) {
                cardSide = 'front';
            } else {
                cardSide = 'back';
            }
            document.getElementById('mfaCard').classList.toggle('mfa-card-flipped');
        }

        function flipCardTo(side) {
            if (side === 'front') {
                document.getElementById('mfaCard').classList.remove('mfa-card-flipped');
            } else if (side === 'back') {
                document.getElementById('mfaCard').classList.add('mfa-card-flipped');
            } else {
                console.error('Invalid side:', side);
            }
        }

        function applySchoolColors(colors) {
            const color1 = '#' + colors.substring(0, 6);
            const color2 = '#' + colors.substring(6, 12);

            const adjustColor = (color, amount) => '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));

            const bgPalette = [40, 20, 0, -20].map(amount => adjustColor(color1, amount));
            const cardPalette = [40, 20, 0, -20].map(amount => adjustColor(color2, amount));

            // Set up the new background
            const newBackground = document.getElementById('new-background');
            newBackground.style.background = `radial-gradient(circle at bottom, ${bgPalette[0]} 20%, ${bgPalette[1]} 20%, ${bgPalette[1]} 28%, ${bgPalette[2]} 28%, ${bgPalette[2]} 36%, ${bgPalette[3]} 36%, ${bgPalette[3]} 44%, ${bgPalette[3]} 44%)`;

            // Fade in the new background
            setTimeout(() => {
                newBackground.style.opacity = '1';
                document.getElementById('background').style.opacity = '0';
            }, 0);

            // Update card colors
            ['1', '2', '3', '4'].forEach((num, index) => {
                document.documentElement.style.setProperty(`--card-color-${num}`, cardPalette[index]);
            });
        }

        async function sendSMSCode() {
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'send_sms_code',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.log('Error sending SMS code:', error);
                showAlert('Failed to send SMS code: ' + error.message);
                flipCardTo('front');
            }
        }

        async function sendEmailCode() {
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'send_code',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.log('Error sending email code:', error);
                showAlert('Failed to send email code: ' + error.message);
                flipCardTo('front');
            }
        }

        async function sendPushNotification() {
            try {
                if (isSessionExpired) {
                    return;
                }
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'send_push_notification',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal
                    }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.log('Error sending push notification:', error);
                showAlert('Failed to send push notification: ' + error.message);
                flipCardTo('front');
            }
        }

        async function requestInstructorApproval() {
            const teacherEmail = document.getElementById('teacherEmail').value;
            if (!teacherEmail) {
                showAlert('Please enter your teacher\'s email.');
                return;
            }

            try {
                if (isSessionExpired) {
                    return;
                }
                console.log('Sending request with university:', universityGlobal);
                const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'request_instructor_approval',
                        university: universityGlobal,
                        sessionId: sessionIdGlobal,
                        teacherEmail: teacherEmail
                    }),
                });

                const data = await response.json();
                if (!data) {
                    throw new Error('No response from server');
                } else if (data.error) {
                    throw new Error(data.error);
                } else {
                    showAlert('Instructor approval request sent. Waiting for approval...');
                    console.log("Instructor approval request sent successfully.");
                }
                await pollForApproval();  // Start polling for approval
            } catch (error) {
                console.log('Error requesting instructor approval:', error);
                showAlert('Failed to request instructor approval: ' + error.message);
            }
        }

        async function pollForApproval() {
            let pollCount = 0;
            let maxPolls = maxSessionTime / 5;  // Poll every 5 seconds
            let exit = false;
            console.log('Polling for instructor approval...');
            console.log('Max polls:', maxPolls);
            while (!exit && !isSessionExpired) {
                pollCount++;

                try {
                    let temp = document.getElementById('teacherEmail').value;
                    if (temp != null && temp != undefined && temp != '') {
                        teacherEmail = temp;
                    }
                } catch (error) {
                    // this indicates that the teacher request was already sent, and then they clicked back.
                    // just use the existing email then.
                }

                try {
                    if (isSessionExpired) {
                        return;
                    }
                    console.log('Sending approval check to ' + teacherEmail);
                    const response = await fetch('https://xsfzzy6xj6hxcdh2m24qd7f55u0acbpx.lambda-url.us-east-1.on.aws', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'check_approval_status',
                            university: universityGlobal,
                            sessionId: sessionIdGlobal,
                            teacherEmail: teacherEmail
                        }),
                    });

                    const data = await response.json();

                    if (!data) {
                        throw new Error('No response from server');
                    } else if (data.error) {
                        throw new Error(data.error);
                    }

                    if (data.approved) {
                        console.log('Instructor approved.');
                        showAlert('Instructor approval received. You are now authenticated.');

                        // instructor approval is instant authentication, no other methods required
                        completedMethods = numberOfMethodsRequired;
                        isAuthenticated = true;
                        exit = true;
                        clearSessionTimer(); // Clear the session timer
                        updateMFAOptions();
                        if (shouldRedirect) {
                            if (debug_mode) {
                                console.log('Redirecting to:', redirectUrl);
                            } else {
                                goToRedirectUrl();
                            }
                        } else {
                            // if the card is currently on back, flip it to the front
                            flipCardTo('front');
                        }
                    } else if (data.denied) { 
                        console.log('Authentication request denied.');
                        showAlert('Instructor denied authentication request.');
                        exit = true;
                    } else {
                        console.log('Instructor not approved yet.');
                    }
                } catch (error) {
                    if (error.message == 'SESSION_EXPIRED') {
                        console.log('Session expired.');
                        showAlert('Session expired. Please try again.');
                    } else {
                        console.log('Error checking approval status:', error);
                        showAlert('Error checking approval status. Please try again.');
                    }
                    flipCardTo('front');
                    exit = true;
                }

                if (pollCount >= maxPolls) {
                    console.log('Instructor approval timed out.');
                    showAlert('Instructor approval timed out. Please try again or use another authentication method.');

                    flipCardTo('front');
                    exit = true;
                }

                await new Promise(resolve => setTimeout(resolve, 5000));  // Poll every 5 seconds
            }
        }

        function redirectCheckboxUpdate() {
            shouldRedirect = document.getElementById('redirectCheckbox').checked;
        }
    </script>
</body>
</html>